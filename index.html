<!DOCTYPE html>
<html>
<head>
  <title>String Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial;max-width:480px;margin:2rem auto;background:#f8f9fa;padding:1rem;}
    .card{background:#fff;padding:1.5rem;border-radius:12px;margin:1rem 0;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    #code{font-size:2.5rem;font-weight:bold;text-align:center;letter-spacing:0.5rem;margin:1rem 0;}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;}
    .keypad button{font-size:1.8rem;padding:1rem;border-radius:12px;background:#e9ecef;}
    #msg{color:red;text-align:center;margin:1rem 0;}
    #result pre{background:#f1f3f5;padding:1rem;border-radius:8px;word-break:break-all;}
  </style>
</head>
<body>
  <div class="card">
    <h2>Enter 5-Digit Code</h2>
    <div id="code">_____</div>
    <div class="keypad">
      <button onclick="add('1')">1</button><button onclick="add('2')">2</button><button onclick="add('3')">3</button>
      <button onclick="add('4')">4</button><button onclick="add('5')">5</button><button onclick="add('6')">6</button>
      <button onclick="add('7')">7</button><button onclick="add('8')">8</button><button onclick="add('9')">9</button>
      <button onclick="add('0')">0</button><button onclick="back()">Back</button>
    </div>
    <div id="msg"></div>
  </div>

  <div id="pwd" class="card" style="display:none;">
    <input type="password" id="pass" placeholder="2FA Password">
    <button onclick="verify()">Submit</button>
  </div>

  <div id="result" class="card" style="display:none;">
    <h3>StringSession:</h3>
    <pre id="session"></pre>
    <button onclick="copy()">Copy</button>
  </div>

  <script>
    let code = '';
    const phone = new URLSearchParams(location.search).get('phone');
    if (phone) {
      fetch('/send', {method:'POST', body: new URLSearchParams({phone})})
        .then(r => r.json())
        .then(d => document.getElementById('msg').innerHTML = d.ok ? "Code sent!" : d.error);
    }

    function add(d) {
      if (code.length < 5) {
        code += d;
        document.getElementById('code').textContent = code.padEnd(5, '_');
        if (code.length === 5) setTimeout(verify, 500);
      }
    }

    function back() {
      code = code.slice(0, -1);
      document.getElementById('code').textContent = code.padEnd(5, '_');
    }

    async function verify() {
      const pwd = document.getElementById('pass')?.value || '';
      const body = new URLSearchParams({phone, code});
      if (pwd) body.append('pwd', pwd);

      const r = await fetch('/verify', {method:'POST', body});
      const d = await r.json();

      if (d.needs_password) {
        document.getElementById('pwd').style.display = 'block';
      } else if (d.error) {
        document.getElementById('msg').innerHTML = d.error;
        code = '';
        document.getElementById('code').textContent = '_____';
      } else {
        document.getElementById('result').style.display = 'block';
        document.getElementById('session').textContent = d.session;
      }
    }

    function copy() {
      navigator.clipboard.writeText(document.getElementById('session').textContent);
      alert("Copied!");
    }
  </script>
</body>
</html>
