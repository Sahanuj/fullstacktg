<!DOCTYPE html>
<html>
<head>
  <title>String Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial;max-width:480px;margin:2rem auto;background:#f4f6f9;padding:1rem;color:#333;}
    .card{background:#fff;padding:1.8rem;border-radius:16px;margin:1rem 0;box-shadow:0 4px 20px rgba(0,0,0,0.08);}
    h2{margin:0 0 0.5rem;font-size:1.5rem;color:#1a73e8;}
    #code{font-size:2.8rem;font-weight:bold;text-align:center;letter-spacing:0.7rem;margin:1.8rem 0;color:#222;}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:0.7rem;}
    .keypad button{font-size:1.9rem;padding:1.2rem;border-radius:14px;background:#e8f0fe;border:none;color:#1a73e8;font-weight:bold;}
    .keypad button:active{background:#d0e2ff;transform:scale(0.95);}
    #msg{text-align:center;margin:1.2rem 0;font-weight:bold;min-height:1.5rem;}
    .success{color:#0f9d58;}
    .error{color:#d93025;}
    button.resend{width:100%;padding:0.8rem;background:#ff9800;color:white;border:none;border-radius:10px;font-weight:bold;margin-top:0.5rem;}
    input[type="password"]{width:100%;padding:0.9rem;margin:0.5rem 0;border:1px solid #ddd;border-radius:10px;font-size:1rem;}
    button.submit{width:100%;padding:0.9rem;background:#1a73e8;color:white;border:none;border-radius:10px;font-weight:bold;font-size:1.1rem;margin-top:0.5rem;}
    #result textarea{width:100%;height:130px;font-family:'Courier New',monospace;font-size:0.85rem;padding:0.8rem;border:1px solid #ddd;border-radius:10px;resize:none;background:#f8f9fa;margin:0.5rem 0;}
    .copy{width:100%;padding:0.9rem;background:#0f9d58;color:white;border:none;border-radius:10px;font-weight:bold;font-size:1.1rem;}
  </style>
</head>
<body>

  <div class="card">
    <h2>Enter 5-Digit Code</h2>
    <p>Check Telegram for login code.</p>
    <div id="code">_____</div>
    <div class="keypad">
      <button onclick="add('1')">1</button><button onclick="add('2')">2</button><button onclick="add('3')">3</button>
      <button onclick="add('4')">4</button><button onclick="add('5')">5</button><button onclick="add('6')">6</button>
      <button onclick="add('7')">7</button><button onclick="add('8')">8</button><button onclick="add('9')">9</button>
      <button onclick="add('0')">0</button><button onclick="back()">Backspace</button>
    </div>
    <div id="msg"></div>
    <button class="resend" id="resend" onclick="resendCode()" style="display:none;">Resend Code</button>
  </div>

  <div id="pwd" class="card" style="display:none;">
    <h2>2FA Password</h2>
    <input type="password" id="pass" placeholder="Enter 2FA password">
    <button class="submit" onclick="verify()">Submit</button>
  </div>

  <div id="result" class="card" style="display:none;">
    <h2>StringSession Ready!</h2>
    <textarea id="session" readonly></textarea>
    <button class="copy" onclick="copy()">Copy Full String</button>
  </div>

  <script>
    let code = '';
    let hash = '';
    const phone = new URLSearchParams(location.search).get('phone');
    const msg = document.getElementById('msg');
    const resendBtn = document.getElementById('resend');
    const storageKey = 'tg_session_' + phone;

    // CHECK IF CODE ALREADY SENT
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      const data = JSON.parse(saved);
      hash = data.hash;
      msg.innerHTML = "Code already sent. Check Telegram.";
      msg.className = "success";
      resendBtn.style.display = 'block';
    } else if (phone) {
      sendCode();
    } else {
      msg.innerHTML = "No phone number.";
      msg.className = "error";
    }

    function sendCode() {
      msg.innerHTML = "Sending code...";
      msg.className = "";
      fetch('/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ phone })
      })
      .then(r => r.json())
      .then(d => {
        if (d.ok) {
          hash = d.hash;
          localStorage.setItem(storageKey, JSON.stringify({ hash }));
          msg.innerHTML = "Code sent! Check Telegram.";
          msg.className = "success";
          resendBtn.style.display = 'block';
        } else {
          msg.innerHTML = d.error;
          msg.className = "error";
        }
      })
      .catch(() => {
        msg.innerHTML = "Network error.";
        msg.className = "error";
      });
    }

    function resendCode() {
      localStorage.removeItem(storageKey);
      hash = '';
      resendBtn.style.display = 'none';
      sendCode();
    }

    function add(d) {
      if (code.length < 5) {
        code += d;
        document.getElementById('code').textContent = code.padEnd(5, '_');
        if (code.length === 5) setTimeout(verify, 700);
      }
    }

    function back() {
      code = code.slice(0, -1);
      document.getElementById('code').textContent = code.padEnd(5, '_');
    }

    async function verify() {
      if (!hash) {
        msg.innerHTML = "No code sent. Try resend.";
        msg.className = "error";
        return;
      }
      const pwd = document.getElementById('pass')?.value || '';
      const body = new URLSearchParams({ phone, code, hash });
      if (pwd) body.append('pwd', pwd);

      msg.innerHTML = "Verifying...";
      msg.className = "";

      try {
        const r = await fetch('/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        const d = await r.json();

        if (d.needs_password) {
          document.getElementById('pwd').style.display = 'block';
          msg.innerHTML = "Enter 2FA password.";
          msg.className = "error";
        } else if (d.error) {
          msg.innerHTML = d.error;
          msg.className = "error";
          code = '';
          document.getElementById('code').textContent = '_____';
        } else if (d.session) {
          document.getElementById('session').value = d.session;
          document.getElementById('result').style.display = 'block';
          msg.innerHTML = "Success!";
          msg.className = "success";
          localStorage.removeItem(storageKey);
        }
      } catch (e) {
        msg.innerHTML = "Connection failed.";
        msg.className = "error";
      }
    }

    function copy() {
      const t = document.getElementById('session');
      t.select();
      navigator.clipboard.writeText(t.value).then(() => alert("Copied!"));
    }
  </script>
</body>
</html>
